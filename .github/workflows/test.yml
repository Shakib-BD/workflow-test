# Written by ozipoetra // mitsu00
name: Build Tester

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
env:
  WDIR: ${{github.workspace}}
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: rokibhasansagar/slimhub_actions@main
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 512
          swap-size-mb: 8192
          remove-dotnet: 'true'
          remove-docker-images: 'false'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
      - name: Free Space After Clearing
        run: |
          cd $WDIR
          echo "Free space:"
          df -h
          echo "Current Directory"
          pwd
          ls
      - name: Install Dependency
        run: |
          sudo apt update
          sudo apt install -y openssh-server screen python3 git openjdk-8-jdk android-tools-adb bc \
          bison build-essential curl flex g++-multilib gcc-multilib gnupg gperf imagemagick \
          lib32ncurses-dev lib32readline-dev lib32z1-dev  liblz4-tool libncurses5-dev libsdl1.2-dev \
          libssl-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc \
          yasm zip zlib1g-dev libtinfo5 libncurses5
      # Downloading Tools
      - name: Prepare Repo
        run: |
          #pacman -Sy openssh
          #cd $WDIR
          cd ~ 
          mkdir ~/.bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/.bin/repo
          chmod a+x ~/.bin/repo
          echo "export PATH=~/bin:$PATH" >> ~/.bashrc
          echo "Free Space:"
          df -h
      # Sync Repo (You Can Edit This!)
      - name: Sync Repo
        run: |
          cd $WDIR
          repo init --depth=1 --no-repo-verify -u https://github.com/alphadroid-project/manifest -b alpha-13 --git-lfs -g default,-mips,-darwin,-notdefault
          git clone https://github.com/mitsu00/local_manifest.git --depth 1 -b alpha .repo/local_manifests
          repo sync -c --no-clone-bundle --optimized-fetch --prune --force-sync --fail-fast -j$(nproc --all)
      # Build Test (You Can Edit This!)
      - name: Build Test
        run: |
          cd $WDIR
          . build/envsetup.sh
          export WITH_GMS=0
          export ALLOW_MISSING_DEPENDENCIES=true
          export BUILD_USERNAME=ozipoetra
          export BUILD_HOSTNAME=ozip.my.id
          export TZ=Asia/Jakarta
          lunch lineage_merlinx-user
          mka sepolicy
          mka bootimage
          mka init
